---
title: "K8Sé›†ç¾¤ä¸­Javaå¾®æœåŠ¡JVMé…ç½®è§„èŒƒ"
date: "2026-02-02T15:33:26+08:00"
authors:
  - tinyking
draft: true
---


## 1. æ–‡æ¡£ç›®çš„ï¼ˆPurposeï¼‰

ä¸ºç»Ÿä¸€å…¬å¸åœ¨ **Kubernetes ç¯å¢ƒä¸‹ Java å¾®æœåŠ¡çš„ JVM é…ç½®ç­–ç•¥**ï¼Œé™ä½çº¿ä¸Š OOMã€GC æŠ–åŠ¨ã€Pod OOMKilled ç­‰é«˜é¢‘é—®é¢˜ï¼Œæå‡ç³»ç»Ÿ **ç¨³å®šæ€§ã€å¯ç»´æŠ¤æ€§ä¸äº‹æ•…å¯å¤ç›˜æ€§**ï¼Œç‰¹åˆ¶å®šæœ¬è§„èŒƒã€‚

æœ¬è§„èŒƒé€‚ç”¨äºå…¬å¸ **æ‰€æœ‰æ–°å»ºåŠå­˜é‡ Java å¾®æœåŠ¡**ï¼Œä½œä¸º **é»˜è®¤ JVM é…ç½®åŸºçº¿ï¼ˆBaselineï¼‰**ã€‚

---

## 2. é€‚ç”¨èŒƒå›´ï¼ˆScopeï¼‰

### 2.1 é€‚ç”¨ç¯å¢ƒ

* å®¹å™¨å¹³å°ï¼šKubernetesï¼ˆå«è…¾è®¯äº‘ TKE / ACK ç­‰ï¼‰
* Java ç‰ˆæœ¬ï¼š

  * Java 11 / Java 17ï¼ˆæ¨èï¼‰
  * Java 8 â‰¥ 8u191ï¼ˆå¯ç”¨ï¼‰
* æœåŠ¡ç±»å‹ï¼š

  * Spring Boot
  * Web API / RPC / ç½‘å…³ / æ¶ˆæ¯æ¶ˆè´¹ç±»æœåŠ¡

### 2.2 ä¸é€‚ç”¨åœºæ™¯ï¼ˆéœ€å•ç‹¬è¯„å®¡ï¼‰

* æç«¯ä½å»¶è¿Ÿç³»ç»Ÿï¼ˆP99 < 50msï¼‰
* å†…å­˜å‹è®¡ç®—æœåŠ¡ï¼ˆå¤§å¯¹è±¡ / Cache-heavyï¼‰
* é G1 GCï¼ˆZGC / Shenandoahï¼‰

---

## 3. JVM é…ç½®è®¾è®¡åŸåˆ™ï¼ˆDesign Principlesï¼‰

### åŸåˆ™ 1ï¼š**å®¹å™¨ä¼˜å…ˆï¼ˆContainer Firstï¼‰**

* JVM è¡Œä¸ºå¿…é¡»ä»¥ **cgroup limit** ä¸ºè¾¹ç•Œ
* ç¦æ­¢ä»¥ç‰©ç†æœºæ€ç»´é…ç½® `-Xms/-Xmx`

---

### åŸåˆ™ 2ï¼š**å¼¹æ€§ä¼˜äºä¸€æ¬¡æ€§å æ»¡**

* å…è®¸ JVM åœ¨è¿è¡ŒæœŸ **é€æ­¥æ‰©å †**
* ç¦æ­¢é»˜è®¤ä½¿ç”¨ `Xms = Xmx`

---

### åŸåˆ™ 3ï¼š**å‚æ•°å¯è§£é‡Šã€å¯å¤ç›˜**

* ç¦æ­¢â€œå †å‚æ•°å †ç Œâ€
* æ¯ä¸€é¡¹å‚æ•°å¿…é¡»èƒ½å›ç­”ï¼š

  > *â€œä¸ºä»€ä¹ˆè¦å†™è¿™ä¸€è¡Œï¼Ÿâ€*

---

## 4. JVM æ ‡å‡†é…ç½®æ¨¡æ¿ï¼ˆBaseline Templateï¼‰

> **å…¬å¸é»˜è®¤ JVM é…ç½®ï¼Œ90% æœåŠ¡ç›´æ¥ä½¿ç”¨ï¼Œä¸å…è®¸éšæ„ä¿®æ”¹**

```bash
JAVA_OPTS="
# ===== å®¹å™¨æ„ŸçŸ¥ =====
-XX:+UseContainerSupport

# ===== Heapï¼ˆæ ¸å¿ƒå†…å­˜ç­–ç•¥ï¼‰=====
-XX:InitialRAMPercentage=30
-XX:MaxRAMPercentage=70

# ===== GC ç­–ç•¥ =====
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200

# ===== OOM è¯Šæ–­ =====
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/data/app/dump/heapdump.hprof

# ===== GC æ—¥å¿—ï¼ˆJDK 8 å†™æ³•ï¼‰=====
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-XX:+PrintTenuringDistribution
-Xloggc:/data/app/logs/gc.log

# ===== JVM ç¨³å®šæ€§ =====
-XX:+AlwaysPreTouch
-Djava.security.egd=file:/dev/./urandom
"
```

---

## 5. å…³é”®å‚æ•°è§„èŒƒè¯´æ˜ï¼ˆMandatory Rulesï¼‰

### 5.1 Heap å†…å­˜é…ç½®è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

| å‚æ•°                   | è§„èŒƒå€¼     | è¯´æ˜                   |
| -------------------- | ------- | -------------------- |
| InitialRAMPercentage | **30%** | å¯åŠ¨æœŸä¿å®ˆåˆ†é…ï¼Œé¿å… OOMKilled |
| MaxRAMPercentage     | **70%** | ä¸ºéå †å†…å­˜é¢„ç•™å®‰å…¨ç©ºé—´          |

âŒ **ç¦æ­¢é…ç½®**ï¼š

```text
-Xms = -Xmx
InitialRAMPercentage â‰¥ 80
```

---

### 5.2 GC çº¿ç¨‹é…ç½®è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

âŒ ç¦æ­¢åœ¨æ ‡å‡†æœåŠ¡ä¸­æ˜¾å¼é…ç½®ï¼š

```text
-XX:ParallelGCThreads
-XX:ConcGCThreads
```

åŸå› ï¼š

* Kubernetes CPU limit â‰  ç‰©ç†æ ¸æ•°
* JVM å·²åŸºäº cgroup è‡ªåŠ¨è®¡ç®—
* æ‰‹åŠ¨æŒ‡å®šæ˜“å¯¼è‡´ä¸šåŠ¡çº¿ç¨‹é¥¥é¥¿

---

### 5.3 GC è°ƒä¼˜å‚æ•°è§„èŒƒï¼ˆé™åˆ¶æ€§ï¼‰

é™¤ä»¥ä¸‹å‚æ•°å¤–ï¼Œ**ç¦æ­¢éšæ„å¢åŠ  GC ç›¸å…³å‚æ•°**ï¼š

```text
-XX:+UseG1GC
-XX:MaxGCPauseMillis
```

å¦‚éœ€æ–°å¢å‚æ•°ï¼Œå¿…é¡»æä¾›ï¼š

* GC æ—¥å¿—åˆ†æç»“è®º
* æ˜ç¡®çš„ä¸šåŠ¡æŒ‡æ ‡æ”¹å–„è¯´æ˜

---

## 6. Kubernetes èµ„æºé…ç½®ååŒè§„èŒƒ

### 6.1 Memory é…ç½®ï¼ˆå¼ºåˆ¶ï¼‰

```yaml
resources:
  requests:
    memory: XGi
  limits:
    memory: XGi
```

ğŸ“Œ **request å¿…é¡»ç­‰äº limit**

---

### 6.2 CPU é…ç½®ï¼ˆæ¨èï¼‰

```yaml
resources:
  limits:
    cpu: â‰¥ 2
```

ç†ç”±ï¼š

* G1 å¹¶å‘æ ‡è®°éœ€è¦ CPU
* CPU < 1 core ææ˜“å‡ºç° GC æŠ–åŠ¨

---

## 7. åœºæ™¯åŒ–å˜ä½“ï¼ˆéœ€æŠ€æœ¯è´Ÿè´£äººå®¡æ‰¹ï¼‰

### 7.1 å¯åŠ¨å³é«˜æµé‡æœåŠ¡ï¼ˆç½‘å…³ / MQ Consumerï¼‰

```text
InitialRAMPercentage=45~50
MaxRAMPercentage=75
```

---

### 7.2 å»¶è¿Ÿæ•æ„ŸæœåŠ¡ï¼ˆéœ€å‹æµ‹è¯æ˜ï¼‰

```text
InitialRAMPercentage=40
MaxRAMPercentage=65
MaxGCPauseMillis=100
```

âš ï¸ å¿…é¡»æ»¡è¶³ï¼š

* CPU â‰¥ 2 core
* å†…å­˜ â‰¥ 4Gi
* å¯ç”¨ GC æ—¥å¿—ç›‘æ§

---

## 8. å¸¸è§äº‹æ•…ä¸åæ¨¡å¼ï¼ˆAnti-Patternsï¼‰

### âŒ åæ¨¡å¼ 1ï¼šPod OOMKilled æ—  HeapDump

åŸå› ï¼š

* Heap å æ¯”è¿‡é«˜
* éå †å†…å­˜æ— ç©ºé—´

---

### âŒ åæ¨¡å¼ 2ï¼šGC å‚æ•°â€œçœ‹èµ·æ¥å¾ˆä¸“ä¸šâ€

ç‰¹å¾ï¼š

* å‚æ•°æ•°é‡ > 15
* å¤šæ•°ä¸ºé»˜è®¤å€¼è¦†ç›–
* æ—  GC æ—¥å¿—æ”¯æ’‘

---

## 9. ä¸Šçº¿å‰ JVM å¥åº·æ£€æŸ¥æ¸…å•ï¼ˆChecklistï¼‰

ä¸Šçº¿å‰å¿…é¡»ç¡®è®¤ï¼š

* [ ] JVM å¯åŠ¨å Heap éä¸€æ¬¡æ€§åˆ°é¡¶
* [ ] GC æ—¥å¿—ç›®å½•å¯å†™
* [ ] HeapDump è·¯å¾„ä¸ºç‹¬ç«‹æŒä¹…å·
* [ ] Pod æœªå‡ºç° exit code 137
* [ ] GC Pause P95 < 500ms

---

## 10. è§„èŒƒç»´æŠ¤è¯´æ˜

* æœ¬è§„èŒƒç”± **æ¶æ„ç»„ / å¹³å°ç»„** ç»´æŠ¤
* æ‰€æœ‰åç¦»é…ç½®éœ€å¤‡æ¡ˆ
* æ¯åŠå¹´ç»“åˆ GC æ•°æ®å¤ç›˜ä¸€æ¬¡

---

**ç‰ˆæœ¬**ï¼šv1.0
